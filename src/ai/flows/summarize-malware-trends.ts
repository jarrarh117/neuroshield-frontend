// SummarizeMalwareTrends.ts
'use server';

/**
 * @fileOverview An AI agent that summarizes the latest malware trends.
 *
 * - summarizeMalwareTrends - A function that summarizes the latest malware trends.
 * - SummarizeMalwareTrendsInput - The input type for the summarizeMalwareTrends function.
 * - SummarizeMalwareTrendsOutput - The return type for the summarizeMalwareTrends function.
 */

import {ai} from '@/ai/genkit';
import {z} from 'genkit';
import {GoogleGenerativeAI} from '@google/generative-ai';

const SummarizeMalwareTrendsInputSchema = z.object({
  query: z
    .string()
    .default('newly emerging malware families, notable recent incidents, and their attack tactics')
    .describe(
      'The query or topic to use when searching for malware trends. Defaults to \'newly emerging malware families, notable recent incidents, and their attack tactics\'.'
    ),
});
export type SummarizeMalwareTrendsInput = z.infer<typeof SummarizeMalwareTrendsInputSchema>;

const SummarizeMalwareTrendsOutputSchema = z.object({
  summary: z.string().describe('An AI-generated summary of the latest malware trends based on the input query, focusing on new malware and their attack methods in bullet points.'),
});
export type SummarizeMalwareTrendsOutput = z.infer<typeof SummarizeMalwareTrendsOutputSchema>;

export async function summarizeMalwareTrends(input: SummarizeMalwareTrendsInput): Promise<SummarizeMalwareTrendsOutput> {
  return summarizeMalwareTrendsFlow(input);
}

const summarizeMalwareTrendsFlow = ai.defineFlow(
  {
    name: 'summarizeMalwareTrendsFlow',
    inputSchema: SummarizeMalwareTrendsInputSchema,
    outputSchema: SummarizeMalwareTrendsOutputSchema,
  },
  async (input) => {
    const apiKey = process.env.GOOGLE_API_KEY || process.env.GEMINI_API_KEY;
    
    if (!apiKey) {
      throw new Error('GOOGLE_API_KEY or GEMINI_API_KEY is not configured in environment variables.');
    }

    const genAI = new GoogleGenerativeAI(apiKey);
    const model = genAI.getGenerativeModel({ model: 'gemini-2.5-flash' });

    const prompt = `You are a cybersecurity threat intelligence analyst. Provide information about the TOP 4 CURRENT malware threats that users should be aware of right now.

CRITICAL INSTRUCTIONS:
- List EXACTLY 4 malware threats, no more, no less
- Each threat MUST have a SPECIFIC NAME (e.g., "LockBit 3.0", "Emotet", "QakBot")
- Keep each description SHORT and CONCISE (2-3 bullet points per section)
- Focus on ACTIONABLE information for users

FORMAT YOUR RESPONSE EXACTLY LIKE THIS:

Threat 1: [Specific Malware Name]
- Type: [Type/Class like Ransomware, Trojan, Spyware, etc.]
- Attack Method:
  * [Short point 1]
  * [Short point 2]
- Protection:
  * [Short point 1]
  * [Short point 2]

Threat 2: [Specific Malware Name]
- Type: [Type/Class]
- Attack Method:
  * [Short point 1]
  * [Short point 2]
- Protection:
  * [Short point 1]
  * [Short point 2]

Threat 3: [Specific Malware Name]
- Type: [Type/Class]
- Attack Method:
  * [Short point 1]
  * [Short point 2]
- Protection:
  * [Short point 1]
  * [Short point 2]

Threat 4: [Specific Malware Name]
- Type: [Type/Class]
- Attack Method:
  * [Short point 1]
  * [Short point 2]
- Protection:
  * [Short point 1]
  * [Short point 2]

IMPORTANT: 
- Start each threat with "Threat X: [Malware Name]" where X is 1, 2, 3, or 4
- Use REAL, CURRENT malware names
- Keep it SHORT, CLEAR, and ACTIONABLE
- No introductory text, just the 4 threats`;

    const result = await model.generateContent(prompt);
    const response = result.response;
    const text = response.text();

    if (!text) {
      throw new Error('No output received from the AI model for malware trends summarization.');
    }

    // Try to parse as JSON first, if it fails, use the text directly
    let summary = text;
    try {
      const jsonMatch = text.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        const parsed = JSON.parse(jsonMatch[0]);
        if (parsed.summary) {
          summary = parsed.summary;
        }
      }
    } catch (e) {
      // If JSON parsing fails, use the raw text
      console.log('[summarizeMalwareTrendsFlow] Using raw text response');
    }

    return { summary };
  }
);
